---
name: E2E Tests

'on':
  push:
    branches: [main]
  pull_request_target:
  workflow_dispatch:
    inputs:
      test_models:
        description: >-
          Gemini LLM models to test
        required: false
        default: "gemini/gemini-2.5-pro"

permissions:
  contents: read

jobs:
  gate:
    name: Gate (ok-to-test)
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.gate.outputs.run }}
    steps:
      - name: Decide if e2e should run
        id: gate
        shell: bash
        run: |
          RUN=false
          # Non-PR events (push/workflow_dispatch) always run
          if [ "${{ github.event_name }}" != "pull_request_target" ]; then
            RUN=true
          else
            # For pull_request_target:
            BASE="${{ github.repository }}"
            HEAD="${{ github.event.pull_request.head.repo.full_name }}"
            echo "::notice::Base repo: $BASE"
            echo "::notice::Head repo: $HEAD"
            if [ "$BASE" = "$HEAD" ]; then
              # Same-repo PRs always run
              RUN=true
            else
              # Fork PRs require ok-to-test label
              # Fetch current labels via API (event payload may be stale)
              PR_NUMBER="${{ github.event.pull_request.number }}"
              LABELS_JSON=$(gh api "repos/$BASE/pulls/$PR_NUMBER" --jq '.labels')
              echo "::notice::PR #$PR_NUMBER labels: $LABELS_JSON"
              if echo "$LABELS_JSON" | grep -Eqi '"name":\s*"ok-to-test"'; then
                echo "::notice::Found ok-to-test label - proceeding with E2E"
                RUN=true
              else
                echo "::notice::Fork PR needs 'ok-to-test' label to run E2E."
              fi
            fi
          fi
          echo "::notice::Gate decision: run=$RUN"
          echo "run=$RUN" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

  e2e-secrets-precheck:
    name: E2E secret precheck
    needs: gate
    if: needs.gate.outputs.run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Fail if no LLM API keys set
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "::error::Set GEMINI_API_KEY."
            exit 1
          fi

  e2e-tests:
    name: E2E Tests
    needs: [gate, e2e-secrets-precheck]
    if: needs.gate.outputs.run == 'true'
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: lake
          MYSQL_USER: devlake
          MYSQL_PASSWORD: devlake_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -ptest_password"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
          --tmpfs /var/lib/mysql:rw,noexec,nosuid,size=1024m

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Install MySQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for MySQL to be ready
        run: |
          for i in {1..30}; do
            if mysqladmin ping \
              -h "127.0.0.1" -P 3306 -u root -ptest_password --silent; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: Initialize test database schema and data
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password -e \
            "DROP DATABASE IF EXISTS lake; CREATE DATABASE lake;"
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password lake \
            < testdata/mysql/01-schema.sql
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password lake \
            < testdata/mysql/02-test-data.sql

      - name: Run E2E tests for model
        env:
          TEST_DB_HOST: 127.0.0.1
          TEST_DB_PORT: 3306
          TEST_DB_USER: devlake
          TEST_DB_PASSWORD: devlake_password
          TEST_DB_NAME: lake
          LITELLM_LOGGING: "0"
          LITELLM_DISABLE_LOGGING: "1"
          LITELLM_VERBOSE: "0"
          LITELLM_LOGGING_QUEUE: "0"
          E2E_DB_WAIT_SECS: "45"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          pytest tests/e2e -vv --maxfail=1 --tb=short

      - name: Summarize E2E results
        if: always()
        run: |
          echo "## E2E Tests Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Suite**: Database, Incidents" >> $GITHUB_STEP_SUMMARY
          echo "  Deployments" >> $GITHUB_STEP_SUMMARY
