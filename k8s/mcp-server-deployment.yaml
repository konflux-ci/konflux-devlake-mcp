---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: konflux-mcp-server
  namespace: konflux-devlake
  labels:
    app: konflux-mcp-server
    component: mcp-server
    app.kubernetes.io/instance: devlake
    app.kubernetes.io/name: devlake
    devlakeComponent: ui
  annotations:
    openshift.io/display-name: "Konflux DevLake MCP Server"
    openshift.io/description: "MCP Server for Konflux DevLake data analysis"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: konflux-mcp-server
  template:
    metadata:
      labels:
        app: konflux-mcp-server
        component: mcp-server
        app.kubernetes.io/instance: devlake
        app.kubernetes.io/name: devlake
        devlakeComponent: ui
    spec:
      serviceAccountName: konflux-mcp-server
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      volumes:
        - name: logs-volume
          emptyDir: {}
      containers:
        - name: mcp-server
          image: quay.io/konflux-ci/konflux-devprod/devlake-mcp-server:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
              name: http
          env:
            # Database connection to existing DevLake
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: konflux-devlake-secrets
                  key: MYSQL_SERVER
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: konflux-devlake-secrets
                  key: MYSQL_PORT
            - name: DB_DATABASE
              valueFrom:
                secretKeyRef:
                  name: konflux-devlake-secrets
                  key: MYSQL_DATABASE
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: konflux-devlake-secrets
                  key: MYSQL_USER
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: konflux-devlake-secrets
                  key: MYSQL_PASSWORD
            # Server configuration
            - name: SERVER_HOST
              value: 0.0.0.0
            - name: SERVER_PORT
              value: "3000"
            - name: TRANSPORT
              value: http
            - name: LOG_LEVEL
              value: INFO
            - name: LOG_DIR
              value: /app/logs
            - name: PYTHONPATH
              value: /app
            # OIDC Authentication (Red Hat SSO / Keycloak)
            - name: OIDC_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_ENABLED
                  optional: true
            - name: OIDC_ISSUER_URL
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_ISSUER_URL
                  optional: true
            - name: OIDC_CLIENT_ID
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_CLIENT_ID
                  optional: true
            - name: OIDC_REQUIRED_SCOPES
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_REQUIRED_SCOPES
                  optional: true
            - name: OIDC_JWKS_CACHE_TTL
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_JWKS_CACHE_TTL
                  optional: true
            - name: OIDC_SKIP_PATHS
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_SKIP_PATHS
                  optional: true
            - name: OIDC_VERIFY_SSL
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_VERIFY_SSL
                  optional: true
            # Offline token support (for tokens that don't expire)
            - name: OIDC_OFFLINE_TOKEN_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_OFFLINE_TOKEN_ENABLED
                  optional: true
            - name: OIDC_TOKEN_EXCHANGE_CLIENT_ID
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_TOKEN_EXCHANGE_CLIENT_ID
                  optional: true
            - name: OIDC_ACCESS_TOKEN_CACHE_BUFFER
              valueFrom:
                configMapKeyRef:
                  name: konflux-mcp-config
                  key: OIDC_ACCESS_TOKEN_CACHE_BUFFER
                  optional: true
            # SSE/Long-lived connection timeouts (1 hour)
            - name: SERVER_TIMEOUT_KEEP_ALIVE
              value: "3600"
            - name: SERVER_TIMEOUT_GRACEFUL_SHUTDOWN
              value: "300"
          resources:
            requests:
              cpu: "2"
              memory: "4Gi"
            limits:
              memory: "8Gi"
          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          startupProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 30
          livenessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 120
            periodSeconds: 60
            timeoutSeconds: 30
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          command:
            - python3
          args:
            - konflux-devlake-mcp.py
            - --transport
            - http
            - --host
            - 0.0.0.0
            - --port
            - "3000"
            - --db-host
            - $(DB_HOST)
            - --db-port
            - $(DB_PORT)
            - --db-user
            - $(DB_USER)
            - --db-password
            - $(DB_PASSWORD)
            - --db-database
            - $(DB_DATABASE)
            - --log-level
            - $(LOG_LEVEL)
          volumeMounts:
            - name: logs-volume
              mountPath: /app/logs
